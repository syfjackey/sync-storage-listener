!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("Storage",[],t):"object"==typeof exports?exports.Storage=t():e.Storage=t()}(window,(function(){return function(e){var t={};function i(r){if(t[r])return t[r].exports;var s=t[r]={i:r,l:!1,exports:{}};return e[r].call(s.exports,s,s.exports,i),s.l=!0,s.exports}return i.m=e,i.c=t,i.d=function(e,t,r){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)i.d(r,s,function(t){return e[t]}.bind(null,s));return r},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="/dist/",i(i.s=0)}([function(e,t,i){"use strict";i.r(t);t.default=class{static _throwError(e){throw new Error(e)}static _createSetStorageByType(){let e=this;return"sessionStorage"===this._storageType?function(t,i,r){if(!e._isTypeValue(i,"string"))return null;let s=sessionStorage[t](`${e.prefix}_${i}`,r);try{s=JSON.parse(s)}catch(e){}return s||null}:"localStorage"===this._storageType?function(t,i,r,s){if(!e._isTypeValue(i,"string"))return null;let n=e._isType(s,"number")?1e3*s*60*60+(new Date).getTime():null,a=localStorage[t](`${e.prefix}_${i}`,JSON.stringify({value:r,expire:n}));if(a){if(!(a=JSON.parse(a)).expire||a.expire>(new Date).getTime()){let e=a.value;try{e=JSON.parse(e)}catch(e){}return e}return e._setStorageByType("removeItem",i,null),null}return a}:"cookie"===this._storageType?function(t,i,r,s){if(!e._isTypeValue(i,"string"))return null;let n=e._isType(s,"number")?1e3*s*60*60+(new Date).getTime():null,a=null;switch(t){case"getItem":a=e._getCookie(`${e.prefix}_${i}`);try{a=JSON.parse(a)}catch(e){}break;case"removeItem":e._setCookie(`${e.prefix}_${i}`,"",-1);break;case"setItem":e._setCookie(`${e.prefix}_${i}`,r,n)}return a}:void this._throwError("storageType类型解析失败!")}static _getCookie(e){let t=new RegExp("(^| )"+e+"=([^;]*)(;|$)"),i=document.cookie.match(t);return i?unescape(i[2]):null}static _setCookie(e,t,i){if(i){let r=new Date(i).toUTCString();document.cookie=`${e}=${escape(t)};expires=${r}`}else document.cookie=`${e}=${escape(t)}`}static _backRelated(e,t){let i=[],r=[];if(0===this._related.length)i=e,r=t;else for(let s=0;s<e.length;s++)this._related.includes(e[s])&&(i.push(e[s]),r.push(t[s]));return[i,r]}static _sendStorage(e,t,i){if(!this._enable)return;let[r,s]=this._backRelated(t,i);if("requestStorage"===e||"receiveStorage"===e||r.length>0){let t=`${this.prefix}_${e}_${JSON.stringify(r)}`;localStorage.setItem(t,JSON.stringify(s)),localStorage.removeItem(t)}}static getItem(e){if(this._checkInit(),!this._isTypeValue(e,"string",!0))return this._throwError("key只能是String|Array<String>类型!");if(this._isTypeValue(e,"string"))return this._setStorageByType("getItem",e,null);let t=[];for(let i=0;i<e.length;i++){const r=e[i];t.push(this._setStorageByType("getItem",r,null))}return t}static _resolveFn(e,t,i){if(this._isTypeValue(e,"object")){let{key:t,value:i,expire:r}=e;return this._isTypeValue(i,"string")||(i=JSON.stringify(i)),[[t],[i],[r]]}if(this._isTypeValue(e,"string"))return[[e],[t],[i]];if(this._isTypeValue(e,"array")){let t=[],i=[],r=[];return e.forEach(e=>{let[s,n,a]=this._resolveFn(e);t=t.concat(s),i=i.concat(n),r=r.concat(a)}),[t,i,r]}}static setItem(e,t,i){if(this._checkInit(),!this._isTypeValue(e,"string")&&!this._isTypeValue(e,"object",!0))return this._throwError("key只能是String|object|Array<object>类型!");let[r,s,n]=this._resolveFn(e,t,i);const a=[],o=[];for(let e=0;e<r.length;e++){let t="string"==typeof s[e]?s[e]:JSON.stringify(s[e]);if(this._isFilterInvalid){let i=this._setStorageByType("getItem",r[e],null);if(t===(i="string"==typeof i?i:JSON.stringify(i)))continue}o.push(r[e]),a.push(t),this._setStorageByType("setItem",r[e],t,n[e])}o.length>0&&this._sendStorage("setStorage",o,a)}static removeItem(e){if(this._checkInit(),!this._isTypeValue(e,"string",!0))return this._throwError("key只能是String|Array<String>类型!");let t=this._isTypeValue(e,"string")?[e]:e,i=[];for(let e=0;e<t.length;e++)this._isFilterInvalid&&null===this._setStorageByType("getItem",t[e])||(i.push(t[e]),this._setStorageByType("removeItem",t[e],null));i.length>0&&this._sendStorage("removeStorage",i,Array(i.length).fill(null))}static clear(){this._checkInit();let[e]=this._findStorage();for(const t of e)this._setStorageByType("removeItem",t,null);(e.length>0||!this._isFilterInvalid)&&this._sendStorage("removeStorage",e,Array(e.length).fill(null))}static _createFindStorageFn(){let e=this;const t=new RegExp(`^${this.prefix}_`);return"sessionStorage"===this._storageType?function(){let i=[],r=[];for(const[s,n]of Object.entries(sessionStorage))if(e._isOwnSession(s)){let e=s.replace(t,"");i.push(e),r.push(n)}return[i,r]}:"localStorage"===this._storageType?function(){let i=[],r=[];for(const[s,n]of Object.entries(localStorage))if(e._isOwnSession(s)){let a=s.replace(t,""),o=JSON.parse(n);!o.expires||(new Date).getTime()>parseInt(o.expires,10)?(r.push(o.value),i.push(a)):e._setStorageByType("removeItem",s,null)}return[i,r]}:"cookie"===this._storageType?function(){let i=[],r=[],s=document.cookie.split(";");for(let n=0;n<s.length;n++){let a=s[n].split("="),o=a[0].toString().trim();if(e._isOwnSession(o)){let e=o.replace(t,"");i.push(e),r.push(a[1])}}return[i,r]}:void this._throwError("storageType类型解析失败!")}static _onRequestStorage(){let[e,t]=this._findStorage();this._sendStorage("receiveStorage",e,t),this._handleCallback([],[],"request",this)}static _checkInit(){if(!this._isInit())return this._throwError("使用Storage前,请先调用init初始化或者使用Vue.use注册!")}static _isInit(){return"INIT"===this._initStatus}static _isOwnSession(e){return new RegExp(`^${this.prefix}_`).test(e)}static _sendType(e){if(!e)return;const t=new RegExp(`^${this.prefix+"_([^_]+Storage)_"}`),i=e.match(t);return i&&i[1]}static _questStorage(){if(window.name!==this._winName){if("sessionStorage"!==this._storageType){let[e,t]=this._backRelated(...this._findStorage());return void this._doEventByType("set",e,t,!0)}this._sendStorage("requestStorage",[],[]),this._timer=setTimeout(()=>{window.name=this._winName,this._receiveBack&&this._receiveBack()},this._timeout)}else if(this._isRefeshEmit){let[e,t]=this._backRelated(...this._findStorage());this._doEventByType("set",e,t,!1,!0)}}static _onEvent(e,t){if(!e)return;const i=new RegExp(`^${this.prefix+"_([^_]+Storage)_"}`);let r=e.match(i);if(!(r=r&&r[1])||null==t)return;let s=e.replace(i,"");const n=JSON.parse(s),a=JSON.parse(t);switch(r){case"removeStorage":this._doEventByType("remove",n,a,!1);break;case"setStorage":this._doEventByType("set",n,a,!1);break;case"requestStorage":this._onRequestStorage();break;case"receiveStorage":this._doEventByType("set",n,a,!0)}}static _emitListenerCallback(e,t,i){this._listenerMap[e]&&this._listenerMap[e].forEach(r=>{r(t,i,e,this)})}static _doEventByType(e,t,i,r,s=!1){let n=[];for(let r=0;r<t.length;r++){!s&&"sessionStorage"===this._storageType&&("remove"===e?this._setStorageByType("removeItem",t[r],null):this._setStorageByType("setItem",t[r],i[r]));let a=i[r];try{a=JSON.parse(i[r])}catch(e){}this._emitListenerCallback(t[r],a,e),n.push(a)}this._handleCallback(t,n,e,this),r&&(window.name=this._winName,clearTimeout(this._timer),this._receiveBack&&this._receiveBack())}static ready(){return this._checkInit(),new Promise(e=>{this._enable&&window.name!==this._winName?this._receiveBack=()=>e():e()})}static _registerEvent(){window.addEventListener("storage",e=>{this._onEvent(e.key,e.newValue)})}static _initListener(e){if(this._listenerMap={},!e)return;let t=this._isTypeValue(e,"object")?[e]:e;for(let e=0;e<t.length;e++){const i=t[e];let r=this._isTypeValue(i.callback,"function")?[i.callback]:i.callback.flat(1/0),s=i.key;this._listenerMap[s]?this._listenerMap[s].concat(r):this._listenerMap[s]=r}}static _initRelated(e=[],t){this._enable=t,this._related=this._isTypeValue(e,"string")?[e]:[...e]}static _isLikeListener(e){return!!e&&"object"==typeof e&&this._isTypeValue(e.key,"string")&&(this._isTypeValue(e.callback,"function")||this._isTypeValue(e.callback,"function",!0))}static _isListener(e){if(this._isTypeValue(e,"object"))return this._isLikeListener(e);if(this._isTypeValue(e,"array")&&e.length>0){for(let t=0;t<e.length;t++){const i=e[t];if(!this._isLikeListener(i))return!1}return!0}return!1}static _isType(e,t){return t.toLowerCase()===Object.prototype.toString.call(e).split(" ")[1].replace("]","").toLowerCase()}static _isTypeValue(e,t,i=!1){if(!t)return!1;let r=t.split("|");for(let t=0;t<r.length;t++)if(this._isType(e,r[t]))return!0;if(i&&Array.isArray(e)&&e.length>0){for(let i=0;i<e.length;i++)if(!this._isTypeValue(e[i],t,!1))return!1;return!0}return!1}static _validOptions({prefix:e="cps",filterInvalid:t=!0,callback:i=(()=>null),listener:r,related:s,enable:n=!0,storageType:a="sessionStorage",timeout:o=30,refeshEmit:l=!0}){return this._isTypeValue(e,"string")?void 0===s||this._isTypeValue(s,"string",!0)?this._isTypeValue(i,"function")?r&&!this._isListener(r)?this._throwError("listener必须是Object{key<String>,callback<Function>}|Array<Object>类型"):this._isTypeValue(n,"boolean")?("sessionStorage"!==a&&"localStorage"!==a&&"cookie"!==a&&this._throwError("storageType只能是sessionStorage|localStorage|cookie"),/^[0-9]+$/.test(o)||this._throwError("timeout只能是正整数"),this._isTypeValue(l,"boolean")?this._isTypeValue(t,"boolean")?{prefix:e,callback:i,listener:r,related:s,enable:n,storageType:a,timeout:o,refeshEmit:l,filterInvalid:t}:this._throwError("filterInvalid必须是Boolean类型"):this._throwError("refeshEmit必须是Boolean类型")):this._throwError("enable必须是Boolean类型"):this._throwError("callback必须是Function类型"):this._throwError("related必须是String|Array<String>类型"):this._throwError("prefix必须是String类型")}static _initStaticData(){this._initStatus="INIT",this._timer=null,this._winName="syf_completed"}static _initPrefix(e){this.prefix=e}static _initCallback(e){this._handleCallback=e}static init(e){if("INIT"===this._initStatus)return this._throwError("Storage已经初始化!");let{prefix:t,callback:i,listener:r,related:s,enable:n,storageType:a,timeout:o,refeshEmit:l,filterInvalid:h}=this._validOptions(e||{});this._initStaticData(),this._timeout=o,this._storageType=a,this._isRefeshEmit=l,this._isFilterInvalid=h,this._initPrefix(t),this._initCallback(i),this._initRelated(s,n),this._findStorage=this._createFindStorageFn(),this._setStorageByType=this._createSetStorageByType(),n&&(this._initListener(r),this._registerEvent(),this._questStorage())}static install(e,t={}){this.init(t);let i=t.mountKey&&"string"==typeof t.mountKey?t.mountKey:"$storage";e.prototype[i]&&console.warn(`${i}已存在,原功能将被覆盖!`),e.prototype[i]=this}}}]).default}));
//# sourceMappingURL=sync-storage-listener.min.js.map